---
// src/components/SearchBar.astro

export interface Props {
  instance: string;
}

const { instance } = Astro.props;

const containerId = `search-container-${instance}`;
const inputId = `search-input-${instance}`;
const resultsId = `search-results-${instance}`;
---
<div class="relative w-full max-w-xs" id={containerId}>
  <div class="relative">
    <input
      id={inputId}
      type="text"
      placeholder="Cari halaman atau artikel..."
      class="w-full px-4 py-2 text-sm text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      autocomplete="off"
    />
    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
      <svg class="w-4 h-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
  </div>
  <div id={resultsId} class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-80 overflow-y-auto">
    <!-- Search results will be injected here -->
  </div>
</div>

<style>
  :global(.search-item.selected) {
    @apply bg-gray-100;
  }
</style>

<script define:vars={{ containerId, inputId, resultsId }}>
  const searchInput = document.getElementById(inputId);
  const searchResults = document.getElementById(resultsId);
  const searchContainer = document.getElementById(containerId);
  
  if (searchInput && searchResults && searchContainer) {
    let searchData = [];
    let isDataLoaded = false;
    let selectedIndex = -1;

    async function loadSearchData() {
      if (isDataLoaded) return;
      try {
        const response = await fetch('/api/search.json');
        if (!response.ok) return;
        searchData = await response.json();
        isDataLoaded = true;
      } catch (error) {
        console.error('Error fetching search data:', error);
      }
    }

    function showResults(query) {
      if (!query) {
        searchResults.classList.add('hidden');
        return;
      }

      const lowerCaseQuery = query.toLowerCase();
      const filteredData = searchData.filter(item => 
        item.title.toLowerCase().includes(lowerCaseQuery)
      );

      if (filteredData.length === 0) {
        searchResults.innerHTML = `<div class="px-4 py-2 text-sm text-gray-500">Tidak ada hasil ditemukan</div>`;
      } else {
        searchResults.innerHTML = filteredData
          .map(item => `
            <a href="${item.url}" class="search-item block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              ${item.title}
            </a>
          `)
          .join('');
      }
      
      searchResults.classList.remove('hidden');
      selectedIndex = -1;
    }

    function updateSelection() {
      const items = searchResults.querySelectorAll('.search-item');
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    searchInput.addEventListener('input', (e) => {
      const query = e.target.value;
      showResults(query);
    });

    searchInput.addEventListener('focus', loadSearchData);

    searchInput.addEventListener('keydown', (e) => {
      const items = searchResults.querySelectorAll('.search-item');
      if (items.length === 0) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = (selectedIndex + 1) % items.length;
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        updateSelection();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0) {
          items[selectedIndex].click();
        } else {
          items[0].click();
        }
      }
    });

    document.addEventListener('click', (e) => {
      if (!searchContainer.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });
  }
</script>